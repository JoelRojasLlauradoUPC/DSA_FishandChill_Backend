<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Fish Shop</title>

    <style>
        @font-face {
            font-family: "PixelFont";
            src: url("../font/pixel_font.ttf") format("truetype");
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --ink: #ffffff;
            --stats: rgba(255, 255, 255, .82);
            --ok: #44c08a;
            --ok-hover: #38a676;

            --rar1: #4fe06f;
            --rar2: #3f8cff;
            --rar3: #b15cff;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0;
            font-family: "PixelFont", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
            color: var(--ink);
            background: url("../webResources/fondologin.jpg") center center / cover no-repeat fixed;
            overflow-x: hidden;
        }

        header {
            background: rgba(0, 0, 0, 0.18);
            backdrop-filter: blur(6px);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #ffffff;
        }

        .brand { display: flex; align-items: center; gap: 10px; min-width: 0; }

        .brand img {
            width: 180px;
            height: auto;
            display: block;
            filter: drop-shadow(0 10px 18px rgba(0, 0, 0, .55));
            image-rendering: pixelated;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .coins-badge {
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .16);
            background: rgba(0, 0, 0, 0.35);
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0, 0, 0, .45);
            box-shadow: 0 10px 28px rgba(0,0,0,.25);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: flex-end;
        }

        .nav-btn {
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .16);
            background: rgba(0, 0, 0, 0.22);
            color: #ffffff;
            font-weight: 900;
            cursor: pointer;
            font-family: inherit;
            text-shadow: 0 2px 10px rgba(0, 0, 0, .45);
            transition: transform .12s, background .12s;
            width: fit-content;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, .12);
            transform: translateY(-1px);
        }

        main { max-width: 980px; margin: 20px auto; padding: 0 20px; }

        .page-card {
            background: url("../webResources/pixel_wood_bg.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 10px 28px rgba(0, 0, 0, .35), 0 0 0 1px rgba(255, 255, 255, .10) inset;
            border: 1px solid rgba(255, 255, 255, .18);
            color: #ffffff;
        }

        .title {
            margin: 0 0 14px 0;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            text-shadow: 0 2px 10px rgba(0,0,0,.55);
            letter-spacing: 0.5px;
        }

        .empty-msg {
            display: none;
            text-align: center;
            font-weight: 900;
            font-size: 16px;
            color: var(--stats);
            text-shadow: 0 2px 10px rgba(0,0,0,.45);
            padding: 30px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 14px;
        }

        .card {
            background: url("../webResources/pixel_wood_bg.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 10px 28px rgba(0, 0, 0, .30), 0 0 0 1px rgba(255, 255, 255, .10) inset;
            border: 1px solid rgba(255, 255, 255, .18);
            color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-top {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 12px;
            align-items: stretch;
        }

        .img-box {
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,.16);
            background: rgba(0,0,0,.22);
            box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
            padding: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }

        .img-overlay {
            position: absolute;
            inset: 0;
            border-radius: 16px;
            opacity: 0.18;
            pointer-events: none;
            z-index: 2;
        }

        .overlay-1 { background: var(--rar1); }
        .overlay-2 { background: var(--rar2); }
        .overlay-3 { background: var(--rar3); }

        .img-box img {
            width: 100%;
            height: auto;
            display: block;
            image-rendering: pixelated;
            filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
            position: relative;
            z-index: 1;
        }

        .data {
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,.16);
            background: rgba(0,0,0,.18);
            box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
            padding: 12px;
            min-height: 120px;
            overflow: hidden;
        }

        .line {
            margin: 6px 0;
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,.45);
            line-height: 1.15;
            word-break: break-word;
        }

        .muted { color: var(--stats); font-weight: 800; }

        .top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 4px;
        }

        .rarity-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.16);
            background: rgba(0,0,0,.28);
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,.45);
            box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
            white-space: nowrap;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            display: inline-block;
            box-shadow: 0 6px 14px rgba(0,0,0,.35);
        }

        .dot-1 { background: var(--rar1); }
        .dot-2 { background: var(--rar2); }
        .dot-3 { background: var(--rar3); }

        .rt-1 { color: var(--rar1); }
        .rt-2 { color: var(--rar2); }
        .rt-3 { color: var(--rar3); }

        .price-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(0,0,0,.18);
            box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
            width: 100%;
        }

        .price-row label {
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,.45);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .price-right {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .coin-icon { display: inline-block; transform: translateY(1px); }

        .price-row input {
            width: 140px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.16);
            background: rgba(0,0,0,.30);
            color: #fff;
            font-family: inherit;
            font-weight: 900;
            outline: none;
            user-select: text;
            text-align: right;
        }

        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 2px;
        }

        .arrow-btn {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.16);
            background: rgba(0,0,0,.22);
            color: #fff;
            font-weight: 900;
            cursor: pointer;
            font-family: inherit;
            text-shadow: 0 2px 10px rgba(0,0,0,.45);
            transition: transform .12s, background .12s;
            min-width: 54px;
        }

        .arrow-btn:hover {
            background: rgba(255,255,255,.12);
            transform: translateY(-1px);
        }

        .arrow-btn:disabled {
            opacity: .55;
            cursor: not-allowed;
            transform: none;
        }

        .sell-btn {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.20);
            background: var(--ok);
            color: #fff;
            font-weight: 900;
            cursor: pointer;
            font-family: inherit;
            transition: transform .12s, background .12s;
            text-transform: uppercase;
            min-width: 120px;
            text-shadow: 0 2px 10px rgba(0,0,0,.45);
        }

        .sell-btn:hover {
            background: var(--ok-hover);
            transform: translateY(-1px);
        }

        .sell-btn:disabled {
            opacity: .55;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 860px) {
            .grid { grid-template-columns: 1fr; }
            .card-top { grid-template-columns: 160px 1fr; }
        }
    </style>
</head>

<body>
<header>
    <div class="brand">
        <img src="../webResources/mainlogo.png" alt="Fish & Chill">
    </div>

    <div class="header-right">
        <div class="coins-badge">
            ðŸª™ Coins: <span id="coinsValue">...</span>
        </div>
        <button class="nav-btn" id="backBtn" type="button">Go back to shop</button>
        <button class="nav-btn" id="logoutBtn" type="button">Log Out</button>
    </div>
</header>

<main>
    <div class="page-card">
        <p class="title">WELCOME TO THE FISH SHOP</p>

        <p class="empty-msg" id="emptyMsg">You donâ€™t have any fish to sell.</p>

        <div class="grid" id="grid"></div>
    </div>
</main>

<script>
    document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = '../shop';
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = '../index.html';
    });

    const coinsValue = document.getElementById('coinsValue');
    const emptyMsg = document.getElementById('emptyMsg');
    const grid = document.getElementById('grid');

    let groups = new Map();
    let indices = new Map();

    function requireAuth() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '../index.html';
            return null;
        }
        return token;
    }

    function getSpeciesName(s) {
        if (typeof s === 'string') return s;
        if (s && typeof s === 'object') return s.name ?? s.speciesName ?? s.fishSpeciesName ?? s.fishSpecies ?? null;
        return null;
    }

    function getRarityFromFish(f) {
        const r =
            f?.rarity ??
            f?.fishRarity ??
            f?.fishSpecies?.rarity ??
            f?.fishSpecies?.fishRarity ??
            f?.fishSpecies?.rarityLevel ??
            f?.fishSpecies?.rarityId ??
            1;

        const n = Number(r);
        if (n === 2 || n === 3) return n;
        return 1;
    }

    function rarityLabel(r) {
        if (r === 2) return 'Rare';
        if (r === 3) return 'Legendary';
        return 'Common';
    }

    function formatCaptureTime(isoString) {
        if (!isoString) return '-';
        const d = new Date(isoString);

        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const MM = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();

        return `${hh}:${mm} - ${dd}/${MM}/${yyyy}`;
    }

    async function loadCoins() {
        const token = requireAuth();
        if (!token) return;

        const res = await fetch('/api/me', { method: 'GET', headers: { 'Authorization': token } });
        if (!res.ok) {
            localStorage.removeItem('authToken');
            window.location.href = '../index.html';
            return;
        }

        const user = await res.json();
        coinsValue.textContent = String(user.coins ?? 0);
    }

    async function loadCapturedFishes() {
        const token = requireAuth();
        if (!token) return;

        const res = await fetch('/api/me/captured_fishes', { method: 'GET', headers: { 'Authorization': token } });
        if (!res.ok) return;

        const list = await res.json();
        buildGroups(Array.isArray(list) ? list : []);
        renderGrid();
    }

    function buildGroups(list) {
        groups = new Map();
        indices = new Map();

        for (const f of list) {
            const species = getSpeciesName(f.fishSpecies) ?? getSpeciesName(f.fishSpeciesName) ?? '';
            if (!species) continue;

            if (!groups.has(species)) groups.set(species, []);
            groups.get(species).push(f);
        }

        for (const [species] of groups) {
            indices.set(species, 0);
        }
    }

    function setEmptyState() {
        grid.innerHTML = '';
        emptyMsg.style.display = 'block';
    }

    function setNonEmptyState() {
        emptyMsg.style.display = 'none';
    }

    function suggestedPrice(weight) {
        return Math.round(Number(weight || 0) * 20);
    }

    function renderGrid() {
        if (!groups || groups.size === 0) {
            setEmptyState();
            return;
        }

        setNonEmptyState();
        grid.innerHTML = '';

        const speciesNames = Array.from(groups.keys()).sort((a, b) => {
            const ra = getRarityFromFish((groups.get(a) || [])[0]);
            const rb = getRarityFromFish((groups.get(b) || [])[0]);
            if (ra !== rb) return ra - rb;
            return a.localeCompare(b);
        });

        for (const species of speciesNames) {
            const stack = groups.get(species);
            if (!stack || stack.length === 0) continue;

            const i = Math.max(0, Math.min(indices.get(species) ?? 0, stack.length - 1));
            indices.set(species, i);

            const f = stack[i];
            const rarity = getRarityFromFish(f);

            const card = document.createElement('div');
            card.className = 'card';

            const top = document.createElement('div');
            top.className = 'card-top';

            const imgBox = document.createElement('div');
            imgBox.className = 'img-box';

            const overlay = document.createElement('div');
            overlay.className = `img-overlay overlay-${rarity}`;

            const img = document.createElement('img');
            img.alt = species;
            img.src = `../img/fishes/${encodeURIComponent(species)}.png`;
            img.onerror = () => { img.removeAttribute('src'); };

            imgBox.appendChild(overlay);
            imgBox.appendChild(img);

            const data = document.createElement('div');
            data.className = 'data';

            const topRow = document.createElement('div');
            topRow.className = 'top-row';

            const fishIdxLine = document.createElement('p');
            fishIdxLine.className = 'line';
            fishIdxLine.style.margin = '0';
            fishIdxLine.innerHTML = `Fish <span class="muted">${i + 1}/${stack.length}</span>`;

            const badge = document.createElement('span');
            badge.className = 'rarity-badge';
            badge.innerHTML = `<span class="dot dot-${rarity}"></span><span class="rt-${rarity}">${rarityLabel(rarity)}</span>`;

            topRow.appendChild(fishIdxLine);
            topRow.appendChild(badge);

            const l1 = document.createElement('p');
            l1.className = 'line';
            l1.innerHTML = `Species: <span class="muted">${species}</span>`;

            const l2 = document.createElement('p');
            l2.className = 'line';
            l2.innerHTML = `Weight: <span class="muted">${(f.weight ?? '-')}</span>`;

            const l3 = document.createElement('p');
            l3.className = 'line';
            l3.innerHTML = `Capture time: <span class="muted">${formatCaptureTime(f.captureTime)}</span>`;

            data.appendChild(topRow);
            data.appendChild(l1);
            data.appendChild(l2);
            data.appendChild(l3);

            top.appendChild(imgBox);
            top.appendChild(data);

            const priceRow = document.createElement('div');
            priceRow.className = 'price-row';

            const priceLabel = document.createElement('label');
            priceLabel.innerHTML = `<span class="coin-icon">ðŸª™</span>Sell price (coins)`;

            const priceRight = document.createElement('div');
            priceRight.className = 'price-right';

            const coin2 = document.createElement('span');
            coin2.className = 'coin-icon';
            coin2.textContent = 'ðŸª™';

            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.min = '0';
            priceInput.step = '1';
            priceInput.value = String(suggestedPrice(f.weight));

            priceRight.appendChild(coin2);
            priceRight.appendChild(priceInput);

            priceRow.appendChild(priceLabel);
            priceRow.appendChild(priceRight);

            const controls = document.createElement('div');
            controls.className = 'controls';

            const prev = document.createElement('button');
            prev.className = 'arrow-btn';
            prev.type = 'button';
            prev.textContent = 'â—€';
            prev.disabled = (i === 0);

            const sell = document.createElement('button');
            sell.className = 'sell-btn';
            sell.type = 'button';
            sell.textContent = 'SELL';

            const next = document.createElement('button');
            next.className = 'arrow-btn';
            next.type = 'button';
            next.textContent = 'â–¶';
            next.disabled = (i === stack.length - 1);

            prev.addEventListener('click', () => {
                const cur = indices.get(species) ?? 0;
                if (cur > 0) indices.set(species, cur - 1);
                renderGrid();
            });

            next.addEventListener('click', () => {
                const cur = indices.get(species) ?? 0;
                if (cur < stack.length - 1) indices.set(species, cur + 1);
                renderGrid();
            });

            sell.addEventListener('click', async () => {
                const token = requireAuth();
                if (!token) return;

                const curIdx = indices.get(species) ?? 0;
                const arr = groups.get(species) || [];
                if (arr.length === 0) return;

                const fish = arr[Math.max(0, Math.min(curIdx, arr.length - 1))];
                const price = Number(priceInput.value || 0);

                sell.disabled = true;

                const res = await fetch('/api/shop/captured_fishes/sell', {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fishSpeciesName: species,
                        captureTime: fish.captureTime,
                        price: price
                    })
                });

                sell.disabled = false;

                if (!res.ok) return;

                arr.splice(curIdx, 1);

                if (arr.length === 0) {
                    groups.delete(species);
                    indices.delete(species);
                } else {
                    const newIdx = Math.min(curIdx, arr.length - 1);
                    indices.set(species, newIdx);
                }

                renderGrid();
                loadCoins();
            });

            controls.appendChild(prev);
            controls.appendChild(sell);
            controls.appendChild(next);

            card.appendChild(top);
            card.appendChild(priceRow);
            card.appendChild(controls);

            grid.appendChild(card);
        }

        if (grid.children.length === 0) setEmptyState();
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadCoins();
        await loadCapturedFishes();
    });
</script>

</body>
</html>
