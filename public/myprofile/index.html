<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>My Profile</title>

    <style>
        @font-face {
            font-family: "PixelFont";
            src: url("../font/pixel_font.ttf") format("truetype");
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --ink: #ffffff;
            --stats: rgba(255, 255, 255, .82);
            --danger: #c84646;
            --danger-hover: #a93c3c;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            font-family: "PixelFont", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
            color: var(--ink);
            background: url("../webResources/fondologin.jpg") center center / cover no-repeat fixed;
            overflow-x: hidden;
        }

        header {
            background: rgba(0, 0, 0, 0.18);
            backdrop-filter: blur(6px);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #ffffff;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .brand img {
            width: 180px;
            height: auto;
            display: block;
            filter: drop-shadow(0 10px 18px rgba(0, 0, 0, .55));
            image-rendering: pixelated;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .16);
            background: rgba(0, 0, 0, 0.22);
            color: #ffffff;
            font-weight: 800;
            cursor: pointer;
            font-family: inherit;
            text-shadow: 0 2px 10px rgba(0, 0, 0, .45);
            transition: transform .12s, background .12s;
            width: fit-content;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, .12);
            transform: translateY(-1px);
        }

        main {
            max-width: 980px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .card {
            background: url("../webResources/pixel_wood_bg.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 10px 28px rgba(0, 0, 0, .35), 0 0 0 1px rgba(255, 255, 255, .10) inset;
            border: 1px solid rgba(255, 255, 255, .18);
            color: #ffffff;
        }

        .profile-title {
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, .55);
        }

        .profile-line {
            margin: 8px 0;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, .45);
        }

        .muted {
            color: var(--stats);
            font-weight: 700;
        }

        .danger-wrap {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
        }

        .danger-btn {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .20);
            background: var(--danger);
            color: #ffffff;
            font-weight: 900;
            cursor: pointer;
            font-family: inherit;
            transition: transform .12s, background .12s;
            text-transform: uppercase;
        }

        .danger-btn:hover {
            background: var(--danger-hover);
            transform: translateY(-1px);
        }

        .danger-btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 18px;
        }

        .modal {
            width: min(560px, 100%);
            background: rgba(0, 0, 0, 0.78);
            border: 1px solid rgba(255, 255, 255, .18);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 16px 40px rgba(0,0,0,.55);
        }

        .modal p {
            margin: 0 0 12px 0;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, .45);
            line-height: 1.35;
        }

        .modal code {
            user-select: text;
            background: rgba(255,255,255,0.08);
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.12);
        }

        .modal input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .16);
            background: rgba(0, 0, 0, 0.30);
            color: #ffffff;
            font-family: inherit;
            font-weight: 800;
            outline: none;
        }

        .modal-actions {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .modal-error {
            margin-top: 10px;
            color: #ffb3b3;
            font-weight: 800;
            display: none;
        }

        .goodbye-title {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .goodbye-actions {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>

<body>

<header>
    <div class="brand">
        <img src="../webResources/mainlogo.png" alt="Fish & Chill">
    </div>

    <div class="header-right">
        <button class="nav-btn" id="backToShopBtn" type="button">Go back to shop</button>
        <button class="nav-btn" id="logoutBtn" type="button">Log Out</button>
    </div>
</header>

<main>
    <div class="card">
        <p class="profile-title">Your profile</p>

        <p class="profile-line" id="profile-username">Username: <span class="muted">Loading...</span></p>
        <p class="profile-line" id="profile-email">Email: <span class="muted">Loading...</span></p>
        <p class="profile-line" id="profile-coins">Coins: <span class="muted">Loading...</span></p>

        <div class="danger-wrap">
            <button class="danger-btn" id="openDeleteModalBtn" type="button">DELETE ACCOUNT</button>
        </div>
    </div>
</main>

<!-- Delete confirm modal -->
<div class="modal-backdrop" id="deleteModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="deleteTitle">
        <p id="deleteTitle">
            In order to delete your account, please, write: <code>DELETE MY ACCOUNT</code>.
        </p>

        <input id="deleteConfirmInput" type="text" placeholder='Type: DELETE MY ACCOUNT' autocomplete="off"/>

        <div class="modal-actions">
            <button class="nav-btn" id="cancelDeleteBtn" type="button">Cancel</button>
            <button class="danger-btn" id="confirmDeleteBtn" type="button" disabled>DELETE</button>
        </div>

        <div class="modal-error" id="deleteError"></div>
    </div>
</div>

<!-- Goodbye modal -->
<div class="modal-backdrop" id="goodbyeBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
        <p class="goodbye-title">Account deleted</p>
        <p>
            Weâ€™re sad to see you go ðŸ’” --- Thank you for playing Fish &amp; Chill.
            We hope you enjoyed your time fishing with us.
        </p>
        <div class="goodbye-actions">
            <button class="danger-btn" id="byeBtn" type="button">BYE</button>
        </div>
    </div>
</div>

<script>
    document.getElementById('backToShopBtn').addEventListener('click', () => {
        window.location.href = '../shop';
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = '../index.html';
    });

    async function loadMe() {
        const token = localStorage.getItem('authToken');

        if (!token) {
            window.location.href = '../index.html';
            return;
        }

        const res = await fetch('/api/me', {
            method: 'GET',
            headers: { 'Authorization': token }
        });

        if (!res.ok) {
            localStorage.removeItem('authToken');
            window.location.href = '../index.html';
            return;
        }

        const user = await res.json();

        document.getElementById('profile-username').innerHTML = `Username: <span class="muted">${user.username}</span>`;
        document.getElementById('profile-email').innerHTML = `Email: <span class="muted">${user.email}</span>`;
        document.getElementById('profile-coins').innerHTML = `Coins: <span class="muted">${user.coins}</span>`;
    }

    const deleteBackdrop = document.getElementById('deleteModalBackdrop');
    const openDeleteModalBtn = document.getElementById('openDeleteModalBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteConfirmInput = document.getElementById('deleteConfirmInput');
    const deleteError = document.getElementById('deleteError');

    const goodbyeBackdrop = document.getElementById('goodbyeBackdrop');
    const byeBtn = document.getElementById('byeBtn');

    function openDeleteModal() {
        deleteError.style.display = 'none';
        deleteError.textContent = '';
        deleteConfirmInput.value = '';
        confirmDeleteBtn.disabled = true;
        deleteBackdrop.style.display = 'flex';
        deleteBackdrop.setAttribute('aria-hidden', 'false');
        setTimeout(() => deleteConfirmInput.focus(), 0);
    }

    function closeDeleteModal() {
        deleteBackdrop.style.display = 'none';
        deleteBackdrop.setAttribute('aria-hidden', 'true');
    }

    function openGoodbyeModal() {
        goodbyeBackdrop.style.display = 'flex';
        goodbyeBackdrop.setAttribute('aria-hidden', 'false');
    }

    openDeleteModalBtn.addEventListener('click', openDeleteModal);
    cancelDeleteBtn.addEventListener('click', closeDeleteModal);

    deleteBackdrop.addEventListener('click', (e) => {
        if (e.target === deleteBackdrop) closeDeleteModal();
    });

    deleteConfirmInput.addEventListener('input', () => {
        confirmDeleteBtn.disabled = (deleteConfirmInput.value !== 'DELETE MY ACCOUNT');
        deleteError.style.display = 'none';
        deleteError.textContent = '';
    });

    async function deleteAccount() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '../index.html';
            return;
        }

        confirmDeleteBtn.disabled = true;
        deleteError.style.display = 'none';
        deleteError.textContent = '';

        const res = await fetch('/api/me', {
            method: 'DELETE',
            headers: { 'Authorization': token }
        });

        if (!res.ok) {
            const text = await res.text().catch(() => 'Delete failed');
            deleteError.textContent = "âŒ " + text;
            deleteError.style.display = 'block';
            confirmDeleteBtn.disabled = false;
            return;
        }

        closeDeleteModal();
        localStorage.removeItem('authToken');
        openGoodbyeModal();
    }

    confirmDeleteBtn.addEventListener('click', deleteAccount);

    byeBtn.addEventListener('click', () => {
        window.location.href = '../register';
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadMe();
    });
</script>

</body>
</html>
